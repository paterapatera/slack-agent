# MCPツール自動ロード拡張

## 概要

LangChain MCPアダプタを用いて、MCPセッションから利用可能なツールを自動的に読み込み、エージェントに登録する仕組みを導入します。これにより、Semche以外のMCP（今後追加予定）も最小変更で取り込めるようにします。

## 実行手順

**必須**: フェーズ内のすべてのタスクにチェックがつくまで、次のフェーズに進まないでください。

### Phase 1: 要件定義・設計【対話フェーズ - ユーザー確認必須】(上から順にチェックしてください)

- [ ] ストーリーの内容を確認する
- [ ] 実現方法を具体化をする
- [ ] **実現方法の具体化内容についてユーザーから承認を得る**
- [ ] 承認を得た内容をストーリーに反映する

#### 実現案

- `mcp.client.stdio.stdio_client` と `mcp.ClientSession` を用いてMCPセッションを初期化し、`langchain_mcp_adapters.tools.load_mcp_tools(session)` で LangChain Tool 群を自動ロードする。
- 初期化は非同期・一度きりにし、結果をキャッシュ（メモ化）して再利用する。
- 失敗時は既存の手動ツール定義（Semcheの手動ラップ）へフォールバック。
- 将来的に複数MCP（Semche以外）を同様に取り込む想定。

### Phase 2: 実装【実装フェーズ - ユーザー確認必須】(上から順にチェックしてください)

- [ ] `agent.py` を非同期初期化対応（`async def get_agent_graph()`）へ変更
- [ ] MCPツール自動ロード関数 `async def load_mcp_tools_once()` を実装（メモ化/ロック）
- [ ] 自動ロード結果が0件/失敗時は手動定義へフォールバック
- [ ] Lint（ruff check . --fix）/ 型チェック（mypy）が通る
- [ ] `CODE_REVIEW_GUIDE.md` に準拠してコードレビューをする
  - AIエージェントが行うので、PRの作成は不要です
- [ ] **ユーザーからのコードレビューを受ける**

### Phase 3: テスト【テストフェーズ】(上から順にチェックしてください)

- [ ] 自動ロード成功: `load_mcp_tools` が呼ばれ Tool が登録される
- [ ] 自動ロード失敗: 手動定義フォールバックが動作する
- [ ] セッション初期化一度きり（メモ化）が担保される

### Phase 4: ドキュメント化【ドキュメント更新フェーズ】(上から順にチェックしてください)

- [ ] `agent.py.exp.md` に自動ロードフローとフォールバックを追記
- [ ] README.md に環境変数・起動手順・依存関係を追記
- [ ] AGENTS.md に本ストーリーの方針と決定を記録

### Phase 5: コミット・プッシュ【最終フェーズ】(上から順にチェックしてください)

- [ ] コードのコミットメッセージを作成する
- [ ] **ユーザーからコミットメッセージの承認を受ける**
- ストーリーにチェック後にコミット・プッシュする

## 追加要件・前提

- 依存関係として `langchain_mcp_adapters`（または同等のMCP→LangChainブリッジ）を導入。
- stdio接続（`MCP_*_PATH`）を基本とし、将来HTTP接続にも対応可能な抽象化を検討。
- 自動ロードは「Agentのツール選択裁量」を前提とし、ツール使用判断はAgentに委譲。
