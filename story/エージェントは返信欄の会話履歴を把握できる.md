# エージェントは返信欄の会話履歴を把握できる

## 概要

Slackボットのエージェントが、スレッド返信時にそのスレッド内の会話履歴（過去のメッセージ）を取得し、文脈を把握した上で応答できるようにする。

## 実行手順

**必須**: フェーズ内のすべてのタスクにチェックがつくまで、次のフェーズに進まないでください。

### Phase 1: 要件定義・設計【対話フェーズ - ユーザー確認必須】(上から順にチェックしてください)

- [x] ストーリーの内容を確認する
- [x] 実現方法を具体化をする
- [x] **実現方法の具体化内容についてユーザーから承認を得る**
- [x] 承認を得た内容をストーリーに反映する

#### 実現案

- Slack APIの`conversations.replies`でスレッド履歴を取得
- 取得した履歴をエージェントのプロンプト（コンテキスト）として渡す
- 履歴取得・整形処理は`handlers/message.py`で実装
- 履歴が長い場合は直近N件のみ利用（トークン数制限に配慮）
- 取得失敗時は履歴なしで応答し、エラーはログ出力

### Phase 2: 実装【実装フェーズ - ユーザー確認必須】(上から順にチェックしてください)

- [x] 履歴取得処理の実装
- [x] エージェントへの履歴渡し処理の実装
- [x] Lint（uv run ruff check . --fix）/ 型チェック（mypy）が通る
- [x] `CODE_REVIEW_GUIDE.md` に準拠してコードレビューをする
  - AIエージェントが行うので、PRの作成は不要です
- [ ] **ユーザーからのコードレビューを受ける**

補足（実装メモ）

- 履歴取得は `conversations.replies(channel, ts, limit=10)` を使用
- 履歴件数は環境変数 `SLACK_HISTORY_LIMIT` で設定可能（デフォルト10、1〜50に正規化）
- 取得失敗時は警告ログを出力し、履歴なしで継続
- 履歴→エージェント入力の変換は簡易規則（`bot_id` があれば assistant、なければ user）
- 現在のメッセージ（event.ts）と重複する履歴要素は除外
- 履歴テキストにも `clean_mention_text` を適用してメンション等を整形
- 最後に現在の質問を user として追加し、messages を作成して呼び出し

レビュー所見（抜粋）

- 可読性: ハンドラー内の履歴取得とエージェント呼び出しが関数分割されており意図が明確。
- エラー処理: Slack API失敗時は警告ログ+継続でユーザー体験を阻害しない。
- 型整合: mypy警告無し。JSONレスポンスを dict のみにフィルタし安全側に倒している。
- 互換性: `invoke_agent` 旧モックとの互換性を TypeError フォールバックで確保。
- セキュリティ/漏えい: 履歴本文全文ログ出力を避け件数のみ記録。
- 改善余地: 履歴件数 limit の設定化 / `<@U123>` メンション除去標準化 / Slack エラーコード別再試行戦略の導入は将来の改善候補。

### Phase 3: テスト【テストフェーズ】(上から順にチェックしてください)

- [x] テストコードを作成する
- [x] テストが全てパスする
- [x] **ユーザーが受け入れテストをする**

受け入れテスト手順（Slack 上で実施）

1. 前提環境:

- Bot が `app_mentions:read`, `chat:write`, `reactions:write` スコープを保持し再インストール済み
- 環境変数 `SLACK_HISTORY_LIMIT` 未設定（デフォルト10）で起動

2. 新規スレッド開始テスト:

- 任意チャンネルで Bot をメンションし質問 "テスト1" → 応答を確認
- 直後に同一スレッドで Bot を再メンションし "テスト2" → 応答が前後関係を反映（"テスト1"の内容を踏まえた応答）するか確認

3. 履歴件数制限テスト:

- 11件以上の短いメンションを連続投稿（最後が質問）→ 応答生成時間とトークン肥大が問題なく、古い初期メッセージが省略されても会話整合性が保たれるか目視

4. limit 環境変数テスト:

- プロセス再起動時に `SLACK_HISTORY_LIMIT=3` を設定し同様に4件以上のやり取り→ 直近3件のみを反映した応答になるか確認

5. :eyes: リアクションテスト:

- メンション送信直後に対象メッセージへ `:eyes:` が付与されるか（既に付与済みなら追加されない）

6. エラー継続性テスト（任意）:

- 一時的に `chat:write` は残し `reactions:write` スコープを外した Bot でメンション→ リアクション失敗ログ後でも応答が返るか（テスト後スコープ復旧）

7. メンションクリーニング確認:

- `<@BOT>   テスト   ` のような余分なスペース入りメンションで質問→ 応答内で先頭メンションが処理されているか（不要引用を含まない）

8. 重複履歴除外確認:

- 同一メッセージの `ts` が会話履歴に二重で含まれていないことをログで確認（"Fetched thread history: N messages" の N が期待通り）

9. 結果記録:

- 主要ケース(2,4,5)のスクリーンショットを取得し受け入れ結果を保存

10. 合格判定:

- すべてのケースで致命的な欠陥なし → チェックを付け Phase4 へ進行

### Phase 4: ドキュメント化【ドキュメント更新フェーズ】(上から順にチェックしてください)

- [x] 実装内容（`*.exp.md`）を更新する
- [x] README.md、AGENTS.md を更新する

### Phase 5: コミット・プッシュ【最終フェーズ】(上から順にチェックしてください)

- [ ] コードのコミットメッセージ(日本語)を作成する
- [ ] **ユーザーからコミットメッセージの承認を受ける**
- ストーリーにチェック後にコミット・プッシュする
