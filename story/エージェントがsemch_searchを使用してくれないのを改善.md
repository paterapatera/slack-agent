# エージェントがsemch_searchを使用してくれないのを改善

## 概要

エージェントが回答生成時に `semch_search`（Semche MCP検索API）を適切に利用しない問題を改善します。これにより、エージェントがユーザーの質問に対して、より関連性の高い情報を取得・活用できるようにします。

## 実行手順

**必須**: フェーズ内のすべてのタスクにチェックがつくまで、次のフェーズに進まないでください。

### Phase 1: 要件定義・設計【対話フェーズ - ユーザー確認必須】(上から順にチェックしてください)

- [x] ストーリーの内容を確認する
- [x] 実現方法を具体化をする
- [x] **実現方法の具体化内容についてユーザーから承認を得る**
- [x] 承認を得た内容をストーリーに反映する

#### 実現案

ユーザー要件反映: 検索の強制は行わず、LangChain Agent がツール選択により `semche_search` を使う/使わないを判断する。社内業務情報（要件/仕様/社内コード/社内ドキュメント等）に関する質問のみ検索し、取得時はドキュメント本文をトリムせず全文利用する。

具体化内容:

1. 事前強制検索ロジック（invoke_agent 内の先行検索注入案）は採用しない。
2. `get_agent_graph()` の system_prompt を拡張しポリシーを明示:

- 社内業務情報が関わる質問では `semche_search` ツールを検討
- 一般的なプログラミング基礎/外部公開情報のみなら使用しない
- 使用時は `include_documents=True` かつ `max_content_length=None` (全文) を推奨

3. ツール description を更新し利用トリガーを明確化し、パラメータ例: `semche_search(query, top_k=5, include_documents=True, max_content_length=None)`。
4. 本文は取得後、回答生成時に必要部分のみ引用・要約（LLMに委譲）する方針。コード側でトリム処理は行わない。
5. テスト追加/更新案:

- 内部系質問モック時: `semche_search` が呼ばれる（MonkeyPatchで呼び出し回数検証）。
- 外部一般質問モック時: `semche_search` が呼ばれない。
- 呼ばれた際のパラメータ: `max_content_length` が None であること。

6. ドキュメント更新: `agent.py.exp.md` にツール選択基準と全文取得方針を記載（ローカル wrapper 削除済みのため MCP ツールのみ）。
7. 失敗時は従来通りログ出力のみでフォールバック（強制再試行せず）。

非機能/前提:

- 強制検索を外すことで不要な API コール削減。
- 全文取得によるレスポンスサイズ増は LLm 側トークン制約で管理（必要なら今後要約フェーズ導入）。

今後拡張余地:

- 質問分類のルール強化（軽量キーワードマッチ→ML分類）。
- 大規模全文のセクション分割要約最適化（複数 chunk の選別）。

### Phase 2: 実装【実装フェーズ - ユーザー確認必須】(上から順にチェックしてください)

- [x] system_prompt を拡張し `semche_search` 利用ポリシーを反映（社内業務情報のみ検討/一般公開質問は非使用/全文取得推奨）
- [x] ツールモジュールの docstring をポリシー・使用例・全文取得推奨付きに拡張
- [x] デフォルト引数で全文取得 (`include_documents=True`, `max_content_length=None`) を維持
- [x] Lint（ruff check . --fix）/ 型チェック（mypy）が通る
- [ ] `CODE_REVIEW_GUIDE.md` に準拠してコードレビューをする（AIエージェント内レビュー）
- [ ] **ユーザーからのコードレビューを受ける**

### Phase 3: テスト【テストフェーズ】(上から順にチェックしてください)

- [x] テストコードを作成する（ポリシー/全文取得設定の検証）
- [x] テストが全てパスする（25 passed）

### Phase 4: ドキュメント化【ドキュメント更新フェーズ】(上から順にチェックしてください)

- [x] `agent.py.exp.md` に semche_search 利用ポリシー/全文取得方針を追記
- [x] ローカル wrapper 削除に伴い `tools/semche.py.exp.md` は作成不要（MCP ツールのみ利用）
- [x] README.md MCP セクションに利用ポリシーと全文取得補足を追記
- [x] AGENTS.md の Phase4更新方針（必要ならポリシー項目追加）

### Phase 5: コミット・プッシュ【最終フェーズ】(上から順にチェックしてください)

- [ ] コードのコミットメッセージを作成する
- [ ] **ユーザーからコミットメッセージの承認を受ける**
- [ ] ストーリーにチェック後にコミット・プッシュする

## 備考

- 強制検索は行っていないため、今後「検出精度向上」のための質問分類（キーワード/ML）導入ストーリーを切り出し可能。
- 外部公開情報に関する質問フィルタは system_prompt による LLM 判断であり、厳密性向上は追加テストで補強予定。
